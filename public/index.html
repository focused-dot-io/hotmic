<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Whisper Transcriber Settings</title>
  <style>
    /* Base styles */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
    }

    /* Container */
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    /* Headers */
    h1 {
      text-align: center;
      color: #333;
      margin-top: 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    /* Form elements */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    button {
      background-color: #007aff;
      color: white;
      border: none;
      padding: 10px 15px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #0055cc;
    }

    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    /* Status messages */
    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-size: 14px;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .info {
      background-color: #e7f3fe;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    /* Shortcut display */
    .current-shortcut {
      display: inline-block;
      padding: 3px 8px;
      background-color: #eee;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      margin-left: 5px;
    }

    /* Footer */
    footer {
      margin-top: 20px;
      text-align: center;
      font-size: 12px;
      color: #777;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Whisper Transcriber Settings</h1>

    <!-- API Key Section -->
    <div class="form-group">
      <label for="apiKey">Groq API Key:</label>
      <input type="password" id="apiKey" placeholder="Enter your Groq API key">
      <button id="saveApiKey">Save API Key</button>
      <div id="apiKeyStatus" class="status"></div>
    </div>

    <!-- Global Shortcut Section -->
    <div class="form-group">
      <label for="shortcut">Global Shortcut:</label>
      <div>
        Current: <span id="currentShortcut" class="current-shortcut">Loading...</span>
        <button id="changeShortcut">Change</button>
      </div>
      <div id="shortcutListener" style="display: none;">
        <p>Press the key combination you want to use:</p>
        <div id="newShortcut" class="current-shortcut">Listening...</div>
        <button id="saveShortcut" disabled>Save</button>
        <button id="cancelShortcut">Cancel</button>
      </div>
      <div id="shortcutStatus" class="status"></div>
    </div>

    <!-- Instructions Section -->
    <div class="form-group">
      <h3>How to Use</h3>
      <ol>
        <li>Press the global shortcut to show the recording overlay</li>
        <li>Speak into your microphone</li>
        <li>Press the shortcut again to stop recording</li>
        <li>Wait for transcription (results copied to clipboard)</li>
      </ol>
    </div>
  </div>

  <footer>
    Whisper Transcriber uses Groq API and Whisper-large-v3 model
  </footer>

  <script>
    /**
     * Whisper Transcriber Settings
     *
     * Manages application settings like API key and global shortcut
     */

    // Application references
    const elements = {
      // API Key elements
      apiKeyInput: document.getElementById('apiKey'),
      saveApiKeyBtn: document.getElementById('saveApiKey'),
      apiKeyStatus: document.getElementById('apiKeyStatus'),

      // Shortcut elements
      currentShortcut: document.getElementById('currentShortcut'),
      changeShortcutBtn: document.getElementById('changeShortcut'),
      shortcutListener: document.getElementById('shortcutListener'),
      newShortcut: document.getElementById('newShortcut'),
      saveShortcutBtn: document.getElementById('saveShortcut'),
      cancelShortcutBtn: document.getElementById('cancelShortcut'),
      shortcutStatus: document.getElementById('shortcutStatus')
    };

    // Application state
    const state = {
      keys: new Set(),
      listeningForShortcut: false
    };

    /**
     * Settings Management
     */

    // Load settings from store
    async function loadSettings() {
      try {
        await loadApiKey();
        await loadShortcut();
      } catch (error) {
        console.error('Error loading settings:', error);
      }
    }

    // Load API key from store
    async function loadApiKey() {
      const apiKey = await window.api.getApiKey();
      if (apiKey) {
        elements.apiKeyInput.value = apiKey;
        showStatus(elements.apiKeyStatus, 'API key is set', 'success');
      }
    }

    // Load shortcut from store
    async function loadShortcut() {
      const shortcut = await window.api.getShortcut();
      elements.currentShortcut.textContent = shortcut;
    }

    // Save API key to store
    async function saveApiKey() {
      const apiKey = elements.apiKeyInput.value.trim();

      if (!apiKey) {
        showStatus(elements.apiKeyStatus, 'Please enter an API key', 'error');
        return;
      }

      try {
        await window.api.setApiKey(apiKey);
        showStatus(elements.apiKeyStatus, 'API key saved successfully', 'success');
      } catch (error) {
        showStatus(elements.apiKeyStatus, `Error saving API key: ${error.message}`, 'error');
      }
    }

    /**
     * Shortcut Management
     */

    // Start listening for shortcut keys
    function startShortcutListener() {
      elements.shortcutListener.style.display = 'block';
      elements.changeShortcutBtn.disabled = true;
      state.listeningForShortcut = true;
      state.keys.clear();
      elements.newShortcut.textContent = 'Listening...';
      elements.saveShortcutBtn.disabled = true;
    }

    // Cancel shortcut change
    function cancelShortcutChange() {
      elements.shortcutListener.style.display = 'none';
      elements.changeShortcutBtn.disabled = false;
      state.listeningForShortcut = false;
    }

    // Save new shortcut
    async function saveShortcut() {
      const shortcutString = elements.newShortcut.textContent;

      try {
        const success = await window.api.setShortcut(shortcutString);

        if (success) {
          elements.currentShortcut.textContent = shortcutString;
          showStatus(elements.shortcutStatus, 'Shortcut saved successfully', 'success');
        } else {
          showStatus(elements.shortcutStatus, 'Failed to register shortcut', 'error');
        }
      } catch (error) {
        showStatus(elements.shortcutStatus, `Error saving shortcut: ${error.message}`, 'error');
      }

      // Reset UI
      cancelShortcutChange();
    }

    // Handle keydown events for shortcut recording
    function handleKeyDown(event) {
      if (!state.listeningForShortcut) return;

      event.preventDefault();

      // Get the key
      let key = event.key;

      // Handle escape key to cancel
      if (key === 'Escape') {
        cancelShortcutChange();
        return;
      }

      // Convert special keys to Electron format
      if (key === ' ') key = 'Space';
      if (key === 'Control') key = 'Ctrl';

      // Capitalize first letter
      key = key.charAt(0).toUpperCase() + key.slice(1);

      // Add to key set
      state.keys.add(key);

      // Update display
      updateShortcutDisplay();
    }

    // Handle keyup events for shortcut recording
    function handleKeyUp(event) {
      if (!state.listeningForShortcut) return;

      // Enable save button if we have valid keys
      if (state.keys.size > 0) {
        elements.saveShortcutBtn.disabled = false;
      }
    }

    // Update shortcut display
    function updateShortcutDisplay() {
      if (state.keys.size === 0) {
        elements.newShortcut.textContent = 'Listening...';
        return;
      }

      // Check for modifiers
      const hasCtrl = state.keys.has('Ctrl');
      const hasAlt = state.keys.has('Alt');
      const hasShift = state.keys.has('Shift');
      const hasMeta = state.keys.has('Meta') || state.keys.has('Command');

      // Build shortcut string
      let shortcutParts = [];

      // Add modifiers first
      if (hasMeta) shortcutParts.push('Command');
      if (hasCtrl) shortcutParts.push('Ctrl');
      if (hasAlt) shortcutParts.push('Alt');
      if (hasShift) shortcutParts.push('Shift');

      // Add other keys
      state.keys.forEach(key => {
        if (!['Ctrl', 'Alt', 'Shift', 'Meta', 'Command'].includes(key)) {
          shortcutParts.push(key);
        }
      });

      // Format for Electron
      const shortcutString = shortcutParts.join('+');
      elements.newShortcut.textContent = shortcutString;
    }

    /**
     * UI Helpers
     */

    // Show status message
    function showStatus(element, message, type) {
      element.textContent = message;
      element.className = `status ${type}`;
    }

    /**
     * Event Binding
     */

    // Bind all event listeners
    function bindEventListeners() {
      // API Key events
      elements.saveApiKeyBtn.addEventListener('click', saveApiKey);

      // Shortcut events
      elements.changeShortcutBtn.addEventListener('click', startShortcutListener);
      elements.cancelShortcutBtn.addEventListener('click', cancelShortcutChange);
      elements.saveShortcutBtn.addEventListener('click', saveShortcut);

      // Key events for shortcut recording
      document.addEventListener('keydown', handleKeyDown);
      document.addEventListener('keyup', handleKeyUp);

      // Error handling
      window.api.onShortcutError && window.api.onShortcutError((message) => {
        showStatus(elements.shortcutStatus, `Error: ${message}`, 'error');
      });
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      bindEventListeners();
    });
  </script>
</body>

</html>